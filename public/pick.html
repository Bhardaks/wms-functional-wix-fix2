
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Toplama</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <style>
    /* Mobile optimizations for pick page */
    @media (max-width: 768px) {
      .desktop-only {
        display: none !important;
      }
      
      .mobile-only {
        display: block !important;
      }
      
      .mobile-item-card {
        background: rgba(31,42,68,0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .mobile-item-card:hover {
        background: rgba(31,42,68,0.5);
        border-color: var(--accent);
      }
      
      .mobile-item-card.completed {
        border-color: var(--success);
        background: rgba(34, 197, 94, 0.1);
      }
      
      .mobile-item-card.partial {
        border-color: var(--warning);
        background: rgba(251, 191, 36, 0.1);
      }
      
      .mobile-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .mobile-item-sku {
        font-weight: bold;
        color: var(--accent);
      }
      
      .mobile-item-status {
        font-size: 18px;
      }
      
      .mobile-item-name {
        font-weight: 500;
        margin-bottom: 8px;
      }
      
      .mobile-item-details {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
        font-size: 12px;
      }
      
      .mobile-item-detail {
        text-align: center;
        padding: 4px;
        background: rgba(0,0,0,0.2);
        border-radius: 4px;
      }
      
      .mobile-item-detail-label {
        color: var(--muted);
        display: block;
        margin-bottom: 2px;
      }
      
      .mobile-item-detail-value {
        font-weight: bold;
        color: var(--fg);
      }
      
      /* Mobile camera optimizations */
      #preview {
        width: 100% !important;
        min-height: 200px !important;
        max-height: 300px !important;
      }
      
      /* Mobile camera toggle button */
      #cameraToggle {
        font-size: 12px !important;
        padding: 6px 12px !important;
      }
      
      #cameraToggle span {
        font-size: 14px;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-only {
        display: none !important;
      }
      
      .desktop-only {
        display: table !important;
      }
    }
  </style>
  <!-- ZXing-js for camera barcode scanning -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
</head>
<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;position:relative;">
    <h1>Toplama</h1>
    <button id="exitPick" class="exit-btn" title="Ã‡Ä±kÄ±ÅŸ yapmak iÃ§in mouse ile 2 kez Ã¼zerine gelin" style="background:#dc3545;color:white;padding:12px 24px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;position:fixed;top:20px;right:20px;z-index:99999;box-shadow:0 4px 8px rgba(0,0,0,0.3);">Ã‡Ä±kÄ±ÅŸ (2x hover)</button>
  </div>
</header>

<main style="max-width:1100px;margin:auto;padding:16px" class="grid">
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2>TarayÄ±cÄ±</h2>
      <div style="display:flex;gap:8px;">
        <button id="debugBtn" style="background:#6f42c1;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">Debug</button>
        <button id="cameraToggle" style="background:#007bff;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;">
          <span id="cameraIcon">ğŸ“·</span>
          <span id="cameraText">Kamera AÃ§</span>
        </button>
      </div>
    </div>
    <video id="preview" autoplay playsinline muted style="width:100%; border-radius:12px; background:#000; max-height:340px; min-height:200px; object-fit:cover; border: 1px solid #ccc; display:none;"></video>
    <div class="flex" style="margin-top:16px;gap:12px;">
      <input id="manual" placeholder="Barkod Girin veya Scanner ile Okutun" class="scanner-input" style="flex:1;font-size:20px;padding:16px;text-align:center;" />
      <button id="enter" class="btn-large" style="background:#22c55e;color:white;min-width:120px;">Ekle</button>
    </div>
    <div style="margin-top:12px;text-align:center;">
      <div style="font-size:14px;color:#888;margin-bottom:8px;">Alternatif: Barkod resmini yÃ¼kleyin</div>
      <input type="file" id="barcodeFile" accept="image/*" capture="environment" style="display:none;" />
      <button onclick="$('#barcodeFile').click()" style="background:#666;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">ğŸ“¸ Resim YÃ¼kle</button>
    </div>
    <div class="grid" style="grid-template-columns: 1fr 1fr;">
      <div><strong>Son Okunan:</strong> <span id="last"></span></div>
      <div style="text-align:right"><a id="pdfLink" target="_blank">Ä°rsaliye PDF</a></div>
    </div>
  </section>

  <section class="card">
    <h2>SipariÅŸ Durumu</h2>
    <div id="orderInfo"></div>
    <div id="itemsContainer">
      <div id="mobileItems" class="mobile-only"></div>
      <table id="items" class="desktop-only"><thead><tr><th>SKU</th><th>ÃœrÃ¼n</th><th>Paketler</th><th>Toplanan</th><th>Adet</th></tr></thead><tbody></tbody></table>
      <div id="packageDetails" class="package-details"></div>
    </div>
  </section>
</main>

<audio id="beepOk"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBYWFhYWFhAAAA" type="audio/wav"></audio>
<audio id="beepErr"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBYWFhYWFhAAAA" type="audio/wav"></audio>

<script type="module">
const $ = (s)=>document.querySelector(s);
const url = new URL(location.href);
const pickId = url.searchParams.get('pick');

let pickData=null;
let currentlyViewedItemId = null; // Hangi item'Ä±n package details'i aÃ§Ä±k

async function loadPick(){
  console.log('Loading pick with ID:', pickId);
  if(!pickId){
    alert('Pick ID bulunamadÄ±! URL\'de ?pick=X parametresi eksik.');
    return;
  }
  
  try {
    const r = await fetch('/api/picks/'+pickId);
    if(!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    pickData = await r.json();
    console.log('Pick data loaded:', pickData);
    
    if(!pickData.order) {
      throw new Error('SipariÅŸ bilgisi bulunamadÄ±');
    }
    
    $('#orderInfo').innerHTML = `
      <div><strong>SipariÅŸ:</strong> ${pickData.order.order_number}</div>
      <div><strong>MÃ¼ÅŸteri:</strong> ${pickData.order.customer_name||'-'}</div>
      <div><strong>Durum:</strong> ${pickData.order.status}</div>
      <div><strong>Pick ID:</strong> ${pickData.pick.id}</div>
    `;
    
    const tb = $('#items tbody');
    console.log('ğŸ“¦ Items data:', pickData.items);
    console.log('ğŸ“¦ Items length:', pickData.items ? pickData.items.length : 'undefined');
    
    if(!pickData.items || pickData.items.length === 0) {
      console.warn('âš ï¸ No items found in pick data!');
      tb.innerHTML = '<tr><td colspan="5">Bu sipariÅŸte hiÃ§ kalem yok</td></tr>';
    } else {
      // Desktop table
      tb.innerHTML = pickData.items.map(it=>{
        const cls = (it.picked_qty>=it.quantity) ? 'completed' : (it.picked_qty > 0 ? 'partial' : '');
        const statusIcon = (it.picked_qty>=it.quantity) ? 'âœ…' : (it.picked_qty > 0 ? 'ğŸ”„' : 'â³');
        
        // Bu item iÃ§in toplanan paket sayÄ±sÄ±nÄ± hesapla
        const scannedPackagesForItem = pickData.scans
          .filter(scan => scan.order_item_id === it.id)
          .length;
        
        // Bu item iÃ§in toplam gerekli paket sayÄ±sÄ±nÄ± hesapla
        const totalRequiredPackages = it.packages 
          ? it.packages.reduce((sum, pkg) => sum + (pkg.quantity * it.quantity), 0)
          : 0;
        
        return `<tr class="${cls}" onclick="showPackageDetails(${it.id})" style="cursor: pointer;">
          <td>${statusIcon} ${it.sku}</td>
          <td>${it.product_name}</td>
          <td><span class="package-count">${it.packages ? it.packages.length : 0} paket</span></td>
          <td class="picked-cell">
            ${totalRequiredPackages > 0 
              ? `<strong>${scannedPackagesForItem}/${totalRequiredPackages}</strong> paket`
              : `<strong>${it.picked_qty}</strong> set`
            }
          </td>
          <td class="quantity-cell">${it.quantity}</td>
        </tr>`
      }).join('');
      
      // Mobile cards
      const mobileContainer = $('#mobileItems');
      mobileContainer.innerHTML = pickData.items.map(it=>{
        const cls = (it.picked_qty>=it.quantity) ? 'completed' : (it.picked_qty > 0 ? 'partial' : '');
        const statusIcon = (it.picked_qty>=it.quantity) ? 'âœ…' : (it.picked_qty > 0 ? 'ğŸ”„' : 'â³');
        
        const scannedPackagesForItem = pickData.scans
          .filter(scan => scan.order_item_id === it.id)
          .length;
        
        const totalRequiredPackages = it.packages 
          ? it.packages.reduce((sum, pkg) => sum + (pkg.quantity * it.quantity), 0)
          : 0;
        
        return `<div class="mobile-item-card ${cls}" onclick="showPackageDetails(${it.id})">
          <div class="mobile-item-header">
            <div class="mobile-item-sku">${it.sku}</div>
            <div class="mobile-item-status">${statusIcon}</div>
          </div>
          <div class="mobile-item-name">${it.product_name}</div>
          <div class="mobile-item-details">
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Paketler</span>
              <span class="mobile-item-detail-value">${it.packages ? it.packages.length : 0}</span>
            </div>
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Toplanan</span>
              <span class="mobile-item-detail-value">
                ${totalRequiredPackages > 0 
                  ? `${scannedPackagesForItem}/${totalRequiredPackages}`
                  : it.picked_qty
                }
              </span>
            </div>
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Adet</span>
              <span class="mobile-item-detail-value">${it.quantity}</span>
            </div>
          </div>
        </div>`
      }).join('');
    }
    $('#pdfLink').href = '/api/picks/'+pickId+'/delivery-note.pdf';
  } catch(error) {
    console.error('Pick yÃ¼kleme hatasÄ±:', error);
    alert('Pick yÃ¼klenemedi: ' + error.message);
    $('#orderInfo').innerHTML = '<div style="color:red">Hata: Pick yÃ¼klenemedi</div>';
  }
}

async function submitBarcode(code){
  console.log('ğŸ” Submitting barcode:', code);
  
  const r = await fetch('/api/picks/'+pickId+'/scan', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ barcode: code })
  });
  const res = await r.json();
  
  console.log('ğŸ“¡ Barcode scan response:', res);
  
  if(res.success){
    $('#last').textContent = code;
    document.getElementById('beepOk').play().catch(()=>{});
    
    // Hemen gÃ¶rsel feedback gÃ¶ster
    $('#last').style.color = 'var(--success)';
    $('#last').style.fontWeight = 'bold';
    setTimeout(() => {
      $('#last').style.color = '';
      $('#last').style.fontWeight = '';
    }, 2000);
    
    console.log('ğŸ”„ Reloading pick data after successful scan...');
    await loadPick();
    
    console.log('ğŸ“Š Updated pickData after scan:', pickData);
    
    // EÄŸer package details aÃ§Ä±ksa otomatik yenile
    if(currentlyViewedItemId) {
      showPackageDetails(currentlyViewedItemId);
    }
    
    if(res.order_completed){
      alert('SipariÅŸ tamamlandÄ±!');
    }
  } else {
    document.getElementById('beepErr').play().catch(()=>{});
    alert(res.error || 'Hata');
  }
}

$('#enter').addEventListener('click', ()=>{
  const v = $('#manual').value.trim();
  if(v) {
    submitBarcode(v);
    $('#manual').value='';
  }
});

// Enter tuÅŸu ile de tarama yapabilme
$('#manual').addEventListener('keypress', (e)=>{
  if(e.key === 'Enter') {
    const v = $('#manual').value.trim();
    if(v) {
      submitBarcode(v);
      $('#manual').value='';
    }
  }
});

// File input handler for barcode images
$('#barcodeFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  console.log('ğŸ“· Processing barcode image...');
  
  try {
    // ZXing ile resimden barcode okuma
    if (typeof ZXing !== 'undefined') {
      const codeReader = new ZXing.BrowserMultiFormatReader();
      const result = await codeReader.decodeFromImageElement(await createImageElement(file));
      
      if (result) {
        const code = result.getText();
        console.log('ğŸ“¸ Barcode read from image:', code);
        submitBarcode(code);
      } else {
        alert('Resimde barkod bulunamadÄ±. LÃ¼tfen daha net bir resim deneyin.');
      }
    } else {
      alert('Resim tarama Ã¶zelliÄŸi ÅŸu anda kullanÄ±lamÄ±yor.');
    }
  } catch (error) {
    console.error('Image barcode reading failed:', error);
    alert('Resimden barkod okunamadÄ±: ' + error.message);
  }
  
  // File input'u temizle
  e.target.value = '';
});

// Helper function to create image element from file
function createImageElement(file) {
  return new Promise((resolve) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    
    img.onload = () => {
      URL.revokeObjectURL(url);
      resolve(img);
    };
    
    img.src = url;
  });
}

// Auto-submit for barcode scanners (Zebra terminals)
let autoSubmitTimer = null;
$('#manual').addEventListener('input', (e) => {
  const value = e.target.value.trim();
  
  // Clear existing timer
  if (autoSubmitTimer) {
    clearTimeout(autoSubmitTimer);
  }
  
  // If value is long enough to be a barcode (usually 6+ chars), auto-submit after delay
  if (value.length >= 6) {
    autoSubmitTimer = setTimeout(() => {
      console.log('ğŸ¤– Auto-submitting barcode:', value);
      if ($('#manual').value.trim() === value) { // Make sure it hasn't changed
        submitBarcode(value);
        $('#manual').value = '';
      }
    }, 300); // 300ms delay for barcode scanners
  }
});

// Modern HTML5 Camera Scanner with legacy support
const video = document.getElementById('preview');
let currentStream = null;
let isScanning = false;
let cameraMode = false; // Kamera modu aktif mi?

// getUserMedia polyfill for older browsers
function getUserMedia(constraints) {
  // Modern browsers
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    return navigator.mediaDevices.getUserMedia(constraints);
  }
  
  // Legacy browsers
  const getUserMediaLegacy = navigator.getUserMedia || 
                            navigator.webkitGetUserMedia || 
                            navigator.mozGetUserMedia || 
                            navigator.msGetUserMedia;
  
  if (!getUserMediaLegacy) {
    return Promise.reject(new Error('getUserMedia is not supported in this browser'));
  }
  
  return new Promise((resolve, reject) => {
    getUserMediaLegacy.call(navigator, constraints, resolve, reject);
  });
}

async function startScanner(){
  console.log('ğŸ¥ Starting camera scanner...');
  
  // Sadece kamera modu aktifse Ã§alÄ±ÅŸtÄ±r
  if (!cameraMode) {
    console.log('ğŸ“± Camera mode is off, skipping camera initialization');
    return;
  }
  
  try{
    // Browser ve API desteÄŸi kontrolÃ¼
    console.log('ğŸ” Checking browser support...');
    console.log('navigator.mediaDevices:', typeof navigator.mediaDevices);
    console.log('navigator.getUserMedia:', typeof navigator.getUserMedia);
    console.log('HTTPS:', location.protocol === 'https:');
    
    // Ã–nce mevcut stream'i temizle
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    
    // HTTPS kontrolÃ¼
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      throw new Error('Kamera eriÅŸimi iÃ§in HTTPS gerekli (localhost hariÃ§)');
    }
    
    // Kamera eriÅŸim izni ve stream baÅŸlat
    const constraints = {
      video: {
        facingMode: { ideal: 'environment' }, // Arka kamera tercih et
        width: { ideal: 640 },  // Daha dÃ¼ÅŸÃ¼k Ã§Ã¶zÃ¼nÃ¼rlÃ¼k iÃ§in uyumluluk
        height: { ideal: 480 }
      }
    };
    
    console.log('ğŸ“± Requesting camera access...');
    currentStream = await getUserMedia(constraints);
    
    // Video elementine stream'i ata
    video.srcObject = currentStream;
    video.setAttribute('playsinline', true); // iOS iÃ§in gerekli
    video.setAttribute('muted', true);
    
    // Video baÅŸlatÄ±lmasÄ±nÄ± bekle
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        console.log('âœ… Camera metadata loaded');
        video.play().then(() => {
          console.log('âœ… Camera started successfully');
          resolve();
        }).catch(err => {
          console.error('âŒ Video play error:', err);
          resolve();
        });
      };
    });
    
    // ZXing ile barcode tarama baÅŸlat
    if (typeof ZXing !== 'undefined') {
      console.log('ğŸ“š ZXing library loaded, starting barcode detection...');
      startBarcodeDetection();
    } else {
      console.warn('âš ï¸ ZXing library not loaded, only camera preview available');
      video.style.border = '3px solid orange';
      // Fallback: Manuel input'a focus
      setTimeout(() => $('#manual').focus(), 1000);
    }
    
  } catch(error) {
    console.error('âŒ Camera initialization failed:', error);
    
    let errorMessage = 'Kamera baÅŸlatÄ±lamadÄ±';
    let showFallback = false;
    
    if (error.name === 'NotAllowedError') {
      errorMessage = 'Kamera izni reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan kamera eriÅŸimine izin verin.';
    } else if (error.name === 'NotFoundError') {
      errorMessage = 'Kamera bulunamadÄ±. LÃ¼tfen cihazÄ±nÄ±zda kamera bulunduÄŸundan emin olun.';
    } else if (error.name === 'NotSupportedError') {
      errorMessage = 'TarayÄ±cÄ±nÄ±z kamera eriÅŸimini desteklemiyor.';
    } else if (error.message.includes('getUserMedia is not supported')) {
      errorMessage = 'Bu tarayÄ±cÄ± kamera eriÅŸimini desteklemiyor. LÃ¼tfen gÃ¼ncel bir tarayÄ±cÄ± kullanÄ±n.';
      showFallback = true;
    } else if (error.message.includes('HTTPS gerekli')) {
      errorMessage = 'Kamera eriÅŸimi iÃ§in gÃ¼venli baÄŸlantÄ± (HTTPS) gerekli.';
      showFallback = true;
    } else {
      errorMessage = `Kamera hatasÄ±: ${error.message}`;
      showFallback = true;
    }
    
    video.style.display = 'none';
    
    // Hata mesajÄ± gÃ¶ster
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = 'background:#ff4444;color:white;padding:20px;border-radius:8px;text-align:center;margin:10px 0;';
    errorDiv.innerHTML = `
      <div style="font-size:24px;margin-bottom:10px;">ğŸ“·</div>
      <div>${errorMessage}</div>
      <div style="margin-top:10px;font-size:14px;">Manuel barkod giriÅŸini kullanabilirsiniz.</div>
      ${showFallback ? '<div style="margin-top:8px;font-size:12px;color:#ffcccb;">TarayÄ±cÄ±: ' + navigator.userAgent.split(' ')[0] + '</div>' : ''}
    `;
    
    video.parentElement.insertBefore(errorDiv, video);
    
    // Manuel input'a focus
    setTimeout(() => $('#manual').focus(), 500);
    
    // Input alanÄ±nÄ± vurgula
    const manualInput = $('#manual');
    if (manualInput) {
      manualInput.style.border = '3px solid #ffd700';
      manualInput.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
      manualInput.placeholder = 'Kamera Ã§alÄ±ÅŸmÄ±yor - Barkodu buraya yazÄ±n';
    }
  }
}

function startBarcodeDetection() {
  if (isScanning) return;
  
  try {
    const codeReader = new ZXing.BrowserMultiFormatReader();
    isScanning = true;
    
    console.log('ğŸ” Starting barcode detection...');
    
    codeReader.decodeFromVideoDevice(undefined, video, (result, error) => {
      if (result) {
        const code = result.getText();
        console.log('ğŸ“± Barcode detected:', code);
        
        // GÃ¶rsel feedback
        video.style.border = '5px solid #22c55e';
        setTimeout(() => {
          video.style.border = '1px solid #ccc';
        }, 500);
        
        // Barkodu iÅŸle
        submitBarcode(code);
        
        // KÄ±sa sÃ¼re taramayÄ± duraklat
        isScanning = false;
        setTimeout(() => {
          if (currentStream && currentStream.active) {
            startBarcodeDetection();
          }
        }, 1000);
      }
      
      if (error && error.name !== 'NotFoundException') {
        console.warn('Barcode detection error:', error);
      }
    });
    
  } catch (error) {
    console.error('Barcode detection failed:', error);
    isScanning = false;
  }
}

// Paket detaylarÄ±nÄ± gÃ¶ster
function showPackageDetails(itemId) {
  currentlyViewedItemId = itemId; // Hangi item'Ä±n detaylarÄ± gÃ¶sterildiÄŸini kaydet
  
  const item = pickData.items.find(it => it.id === itemId);
  if (!item || !item.packages || item.packages.length === 0) {
    $('#packageDetails').innerHTML = '<div class="no-packages">Bu Ã¼rÃ¼n iÃ§in paket tanÄ±mlÄ± deÄŸil</div>';
    return;
  }

  // Taranan paketleri bul
  const scannedPackages = pickData.scans
    .filter(scan => scan.order_item_id === itemId)
    .reduce((acc, scan) => {
      acc[scan.package_id] = (acc[scan.package_id] || 0) + 1;
      return acc;
    }, {});

  const packageHtml = `
    <div class="package-section">
      <h3>ğŸ“¦ ${item.product_name} Paketleri</h3>
      <div class="package-grid">
        ${item.packages.map(pkg => {
          const scannedCount = scannedPackages[pkg.id] || 0;
          const requiredCount = pkg.quantity * item.quantity;
          const isComplete = scannedCount >= requiredCount;
          const progress = requiredCount > 0 ? Math.round((scannedCount / requiredCount) * 100) : 0;
          
          return `
            <div class="package-card ${isComplete ? 'completed' : (scannedCount > 0 ? 'partial' : 'pending')}">
              <div class="package-header">
                <div class="package-name">${pkg.package_name}</div>
                <div class="package-status">${isComplete ? 'âœ…' : (scannedCount > 0 ? 'ğŸ”„' : 'â³')}</div>
              </div>
              <div class="package-barcode">
                <code>${pkg.barcode}</code>
                ${pkg.package_number ? `<small>Paket No: ${pkg.package_number}</small>` : ''}
                ${pkg.package_content ? `<small>Ä°Ã§erik: ${pkg.package_content}</small>` : ''}
              </div>
              <div class="package-count-info">
                <div class="count-display">
                  <span class="scanned-count">${scannedCount}</span> 
                  <span class="separator">/</span> 
                  <span class="total-count">${requiredCount}</span>
                  <span class="count-label">paket</span>
                </div>
                <div class="count-status ${isComplete ? 'completed' : (scannedCount > 0 ? 'partial' : 'pending')}">
                  ${isComplete ? 'TamamlandÄ±' : (scannedCount > 0 ? 'Devam ediyor' : 'Bekleniyor')}
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
  
  $('#packageDetails').innerHTML = packageHtml;
}

// Manuel tarama fonksiyonu - artÄ±k kullanÄ±lmÄ±yor, sadece uyumluluk iÃ§in bÄ±rakÄ±ldÄ±
function manualScan(barcode) {
  $('#manual').value = barcode;
  submitBarcode(barcode);
  
  // Input alanÄ±nÄ± temizle
  setTimeout(() => {
    $('#manual').value = '';
  }, 1000);
}

// Global fonksiyon olarak tanÄ±mla
window.showPackageDetails = showPackageDetails;
window.manualScan = manualScan;

// Yeni Ã§Ä±kÄ±ÅŸ mantÄ±ÄŸÄ± - 3 senaryo
function checkForScannedItems() {
  console.log('ğŸ” Checking for scanned items...');
  console.log('ğŸ” pickData exists:', !!pickData);
  console.log('ğŸ” pickData:', pickData);
  
  if (!pickData) {
    console.log('âŒ No pickData');
    return false;
  }
  
  if (!pickData.order) {
    console.log('âŒ No pickData.order');
    console.log('ğŸ” pickData keys:', Object.keys(pickData));
    return false;
  }
  
  if (!pickData.order.items) {
    console.log('âŒ No pickData.order.items');
    console.log('ğŸ” pickData.order keys:', Object.keys(pickData.order));
    
    // Alternatif olarak pickData.items kontrol et
    if (pickData.items) {
      console.log('âœ… Found pickData.items instead');
      console.log('ğŸ” Full pickData.items data:', pickData.items);
      
      // TÃ¼m item'larÄ± detaylÄ± incele
      pickData.items.forEach((item, index) => {
        console.log(`ğŸ“¦ Item ${index}:`, {
          id: item.id,
          sku: item.sku,
          product_name: item.product_name,
          quantity: item.quantity,
          picked_qty: item.picked_qty,
          allProperties: Object.keys(item)
        });
      });
      
      const scannedItems = pickData.items.filter(item => item.picked_qty > 0);
      console.log('ğŸ“‹ Items with picked_qty > 0 (from pickData.items):', scannedItems.length);
      console.log('ğŸ“‹ All items (from pickData.items):', pickData.items.map(i => ({sku: i.sku, picked_qty: i.picked_qty, quantity: i.quantity})));
      
      // Alternatif: scans sayÄ±sÄ±na gÃ¶re de kontrol et
      if (pickData.scans && pickData.scans.length > 0) {
        console.log('ğŸ” Found scans data:', pickData.scans);
        console.log('ğŸ“Š Number of scans:', pickData.scans.length);
        return true; // EÄŸer scan varsa, tarama yapÄ±lmÄ±ÅŸ demektir
      }
      
      return scannedItems.length > 0;
    }
    
    return false;
  }
  
  const scannedItems = pickData.order.items.filter(item => item.picked_qty > 0);
  console.log('ğŸ“‹ Items with picked_qty > 0 (from pickData.order.items):', scannedItems.length);
  console.log('ğŸ“‹ All items (from pickData.order.items):', pickData.order.items.map(i => ({sku: i.sku, picked_qty: i.picked_qty, quantity: i.quantity})));
  
  return scannedItems.length > 0;
}

function showExitModal() {
  console.log('ğŸš€ Creating exit modal...');
  
  // EÄŸer zaten modal varsa kaldÄ±r
  const existingModal = document.getElementById('exitModal');
  if (existingModal) {
    console.log('ğŸ—‘ï¸ Removing existing modal');
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.id = 'exitModal';
  
  console.log('ğŸ“ Setting modal styles...');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    font-family: inherit;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    padding: 20px;
    border-radius: 12px;
    max-width: 500px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    text-align: center;
    color: black;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  `;
  
  modalContent.innerHTML = `
    <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
    <h2 style="margin: 0 0 15px 0; color: #dc3545;">SipariÅŸ Toplama YarÄ±m KaldÄ±</h2>
    <p style="margin: 0 0 25px 0; color: #666; line-height: 1.5;">
      BazÄ± Ã¼rÃ¼nler taratÄ±ldÄ± ancak sipariÅŸ henÃ¼z tamamlanmadÄ±.<br>
      Ne yapmak istiyorsunuz?
    </p>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <button id="cancelOrder" style="
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background 0.2s;
        min-height: 50px;
        touch-action: manipulation;
      ">
        ğŸ—‘ï¸ SipariÅŸ ToplamayÄ± Ä°ptal Et ve Kapat
      </button>
      
      <button id="savePartial" style="
        background: #ffc107;
        color: #000;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background 0.2s;
        min-height: 50px;
        touch-action: manipulation;
      ">
        ğŸ’¾ Sonra Devam Et (KÄ±smi Toplama Kaydet)
      </button>
      
      <button id="continuePicking" style="
        background: #22c55e;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background 0.2s;
        min-height: 50px;
        touch-action: manipulation;
      ">
        â–¶ï¸ Toplamaya Devam Et
      </button>
    </div>
  `;
  
  console.log('ğŸ“¦ Adding modal to DOM...');
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  console.log('âœ… Modal added to DOM, should be visible');
  console.log('ğŸ” Modal element:', modal);
  console.log('ğŸ” Modal in DOM:', document.getElementById('exitModal'));
  
  // Button hover effects
  const buttons = modalContent.querySelectorAll('button');
  buttons.forEach(btn => {
    btn.addEventListener('mouseenter', () => {
      const currentBg = btn.style.background;
      if (currentBg.includes('#dc3545')) btn.style.background = '#c82333';
      else if (currentBg.includes('#ffc107')) btn.style.background = '#e0a800';
      else if (currentBg.includes('#22c55e')) btn.style.background = '#16a085';
    });
    
    btn.addEventListener('mouseleave', () => {
      if (btn.id === 'cancelOrder') btn.style.background = '#dc3545';
      else if (btn.id === 'savePartial') btn.style.background = '#ffc107';
      else if (btn.id === 'continuePicking') btn.style.background = '#22c55e';
    });
  });
  
  // Event listeners
  $('#cancelOrder').addEventListener('click', handleCancelOrder);
  $('#savePartial').addEventListener('click', handleSavePartial);
  $('#continuePicking').addEventListener('click', handleContinuePicking);
  
  return modal;
}

function closeExitModal() {
  const modal = document.getElementById('exitModal');
  if (modal) {
    modal.remove();
  }
}

async function handleCancelOrder() {
  console.log('ğŸ—‘ï¸ Canceling order and resetting...');
  
  try {
    // SipariÅŸ toplamayÄ± sÄ±fÄ±rla
    const response = await fetch(`/api/picks/${pickId}/reset`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      console.log('âœ… Order picking reset successfully');
      closeExitModal();
      window.location.href = '/orders.html';
    } else {
      console.error('âŒ Failed to reset order picking');
      alert('SipariÅŸ iptal edilirken hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
    }
  } catch (error) {
    console.error('âŒ Error resetting order:', error);
    alert('SipariÅŸ iptal edilirken hata oluÅŸtu: ' + error.message);
  }
}

async function handleSavePartial() {
  console.log('ğŸ’¾ Saving partial pick...');
  
  try {
    // KÄ±smi toplama olarak kaydet
    const response = await fetch(`/api/picks/${pickId}/partial`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      console.log('âœ… Partial pick saved successfully');
      closeExitModal();
      
      // BaÅŸarÄ± mesajÄ± gÃ¶ster
      const successDiv = document.createElement('div');
      successDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #22c55e;
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 10001;
        text-align: center;
        font-weight: bold;
      `;
      successDiv.innerHTML = `
        âœ… KÄ±smi toplama kaydedildi!<br>
        <small>SipariÅŸler sayfasÄ±na yÃ¶nlendiriliyorsunuz...</small>
      `;
      document.body.appendChild(successDiv);
      
      setTimeout(() => {
        window.location.href = '/orders.html';
      }, 2000);
      
    } else {
      console.error('âŒ Failed to save partial pick');
      alert('KÄ±smi toplama kaydedilirken hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
    }
  } catch (error) {
    console.error('âŒ Error saving partial pick:', error);
    alert('KÄ±smi toplama kaydedilirken hata oluÅŸtu: ' + error.message);
  }
}

function handleContinuePicking() {
  console.log('â–¶ï¸ Continuing picking...');
  closeExitModal();
  
  // Focus'u manuel input'a ver
  setTimeout(() => $('#manual').focus(), 100);
}

async function handleExit() {
  console.log('ğŸšª Exit button clicked!');
  console.log('ğŸ” Current pickData state:', pickData);
  
  const hasScannedItems = checkForScannedItems();
  console.log('ğŸ“¦ Has scanned items result:', hasScannedItems);
  
  if (!hasScannedItems) {
    // Senaryo 1: HiÃ§ tarama yapÄ±lmamÄ±ÅŸ - direkt Ã§Ä±k
    console.log('âœ… No scanned items detected, proceeding with direct exit');
    console.log('ğŸ”„ Redirecting to orders page...');
    window.location.href = '/orders.html';
  } else {
    // Senaryo 2: BazÄ± Ã¼rÃ¼nler taratÄ±lmÄ±ÅŸ - modal gÃ¶ster
    console.log('âš ï¸ Scanned items detected! Showing exit modal...');
    
    // Test olarak modal gÃ¶stermeyi deneyelim
    try {
      showExitModal();
      console.log('âœ… Exit modal should be visible now');
    } catch (error) {
      console.error('âŒ Error showing exit modal:', error);
      // Fallback: Basit confirm dialog
      const confirmExit = confirm('SipariÅŸ yarÄ±m kaldÄ±. Ã‡Ä±kmak istiyor musunuz?');
      if (confirmExit) {
        window.location.href = '/orders.html';
      }
    }
  }
}

// Sayfa kapatÄ±lÄ±rken kamera stream'ini temizle
window.addEventListener('beforeunload', (e) => {
  // Kamera stream'ini temizle
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
  
  if (checkForScannedItems() && !document.hidden) {
    e.preventDefault();
    e.returnValue = 'SipariÅŸ henÃ¼z tamamlanmadÄ±. Ã‡Ä±kmak istediÄŸinizden emin misiniz?';
  }
});

// Visibility change'de kamera kontrolÃ¼
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // Sayfa gizlendiÄŸinde kamerayÄ± durdur
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      isScanning = false;
    }
  } else {
    // Sayfa tekrar gÃ¶rÃ¼nÃ¼r olduÄŸunda kamerayÄ± baÅŸlat
    setTimeout(() => {
      if (!currentStream || !currentStream.active) {
        startScanner();
      }
    }, 1000);
  }
});

// Camera toggle functionality
function toggleCameraMode() {
  const toggleBtn = $('#cameraToggle');
  const cameraIcon = $('#cameraIcon');
  const cameraText = $('#cameraText');
  const videoElement = $('#preview');
  
  if (!cameraMode) {
    // Kamera modunu aÃ§
    cameraMode = true;
    
    // UI gÃ¼ncellemeleri
    toggleBtn.style.background = '#dc3545';
    cameraIcon.textContent = 'ğŸ”´';
    cameraText.textContent = 'KamerayÄ± Kapat';
    videoElement.style.display = 'block';
    
    // KamerayÄ± baÅŸlat
    console.log('ğŸ“· Switching to camera mode');
    startScanner();
    
  } else {
    // Kamera modunu kapat
    cameraMode = false;
    
    // Stream'i durdur
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    isScanning = false;
    
    // UI gÃ¼ncellemeleri
    toggleBtn.style.background = '#007bff';
    cameraIcon.textContent = 'ğŸ“·';
    cameraText.textContent = 'Kamera AÃ§';
    videoElement.style.display = 'none';
    videoElement.srcObject = null;
    
    // Hata mesajlarÄ±nÄ± temizle
    const errorDivs = document.querySelectorAll('[style*="background:#ff4444"]');
    errorDivs.forEach(div => div.remove());
    
    console.log('ğŸ“± Switching to manual mode');
    
    // Manuel input'a odaklan
    setTimeout(() => $('#manual').focus(), 200);
  }
}

// Camera toggle button event listener
$('#cameraToggle').addEventListener('click', toggleCameraMode);

// Debug button event listener
$('#debugBtn').addEventListener('click', () => {
  console.log('ğŸ› DEBUG INFORMATION:');
  console.log('ğŸ“Š pickData:', pickData);
  console.log('ğŸ” checkForScannedItems result:', checkForScannedItems());
  
  // Test modal'Ä± gÃ¶ster
  console.log('ğŸ§ª Testing exit modal...');
  showExitModal();
});

await loadPick();

// BaÅŸlangÄ±Ã§ta kamera kapalÄ±, sadece manuel input aktif
$('#manual').focus();
console.log('ğŸ“± Started in manual input mode. Click camera button to enable camera scanning.');

// Zebra Terminal OptimizasyonlarÄ± - Sayfa yÃ¼klenince Ã§alÄ±ÅŸtÄ±r
setTimeout(() => {
  const manualInput = $('#manual');
  
  console.log('ğŸ”§ Setting up barcode auto-focus...');
  
  if (manualInput) {
    // Ä°lk focus
    manualInput.focus();
    manualInput.click(); // iOS iÃ§in gerekli
    
    console.log('âœ… Initial focus set');
    
    // Focus kaybÄ±nÄ± sÃ¼rekli kontrol et
    setInterval(() => {
      if (document.activeElement !== manualInput) {
        manualInput.focus();
      }
    }, 500);
    
    // Her tÄ±klamada focus
    document.addEventListener('click', (e) => {
      if (e.target !== manualInput) {
        setTimeout(() => manualInput.focus(), 50);
      }
    });
    
    // Sayfa gÃ¶rÃ¼nÃ¼r olduÄŸunda focus
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        setTimeout(() => manualInput.focus(), 100);
      }
    });
    
    console.log('âœ… Auto-focus system activated');
  }
}, 1000);

// Visual feedback for successful scan (outside setTimeout)
function showScanFeedback(success) {
  const manualInput = $('#manual');
  if (manualInput) {
    manualInput.style.background = success ? '#22c55e' : '#ef4444';
    manualInput.style.color = 'white';
    setTimeout(() => {
      manualInput.style.background = '#000';
      manualInput.style.color = '#00ff00';
    }, 300);
  }
}

// Zebra device detection and optimizations
const isZebraDevice = /Android/.test(navigator.userAgent) && 
                     (screen.width <= 900 || screen.height <= 900);

if (isZebraDevice) {
  document.body.classList.add('zebra-optimized');
  console.log('ğŸ¦“ Zebra device detected - enabling optimizations');
  
  // Keep camera visible for barcode scanning
  console.log('ğŸ“± Mobile device - keeping camera visible for scanning');
  
  // Prevent screen dim during operation
  if ('wakeLock' in navigator) {
    navigator.wakeLock.request('screen').catch(e => 
      console.log('Wake lock not supported:', e)
    );
  }
}

// Ã‡Ä±kÄ±ÅŸ butonu event listener - load sonrasÄ± ekle
console.log('ğŸ”§ Adding exit button event listener...');
const exitBtn = document.getElementById('exitPick');
console.log('ğŸ”§ Exit button found:', exitBtn);

if (exitBtn) {
  // Multiple ways to add event listener for debugging
  
  // Multiple event types to catch any click
  ['mousedown', 'touchstart', 'click', 'pointerdown'].forEach(eventType => {
    exitBtn.addEventListener(eventType, function(e) {
      console.log(`ğŸ”¥ EXIT BUTTON CLICKED (${eventType})!`);
      e.preventDefault();
      e.stopPropagation();
      
      // Yeni exit logic'i kullan
      handleExit();
    });
  });
  
  // Method 3: Direct style test
  exitBtn.style.pointerEvents = 'all';
  exitBtn.style.zIndex = '9999';
  
  console.log('âœ… Exit button listener added with multiple methods');
  
  // Since click doesn't work, use double hover as trigger
  let hoverCount = 0;
  let hoverTimeout = null;
  
  exitBtn.addEventListener('mouseenter', () => {
    hoverCount++;
    console.log(`ğŸ–±ï¸ Mouse entered exit button! (${hoverCount})`);
    exitBtn.style.backgroundColor = '#b02a37'; // Darker red on hover
    
    // Reset counter after 1 second
    if (hoverTimeout) clearTimeout(hoverTimeout);
    hoverTimeout = setTimeout(() => {
      hoverCount = 0;
    }, 1000);
    
    // Trigger exit on double hover
    if (hoverCount >= 2) {
      console.log('ğŸ”¥ DOUBLE HOVER DETECTED - TRIGGERING EXIT!');
      hoverCount = 0;
      
      // Yeni exit logic'i kullan
      handleExit();
    }
  });
  
  exitBtn.addEventListener('mouseleave', () => {
    exitBtn.style.backgroundColor = '#dc3545'; // Original red
  });
  
  // Test click with setTimeout
  setTimeout(() => {
    console.log('ğŸ§ª Testing button click programmatically...');
    // Don't actually click, just test if button exists
    console.log('ğŸ§ª Button still exists after 2 seconds:', !!document.getElementById('exitPick'));
  }, 2000);
  
} else {
  console.error('âŒ Exit button not found!');
}
</script>
</body>
</html>
