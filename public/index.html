
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>WMS Dashboard</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
</head>
<body>
<header>
  <h1>WMS Dashboard</h1>
  <nav>
    <a href="/index.html">Ana Sayfa</a>
    <a href="/products.html">√úr√ºnler</a>
    <a href="/orders.html">Sipari≈üler</a>
  </nav>
  <div id="mobileNav" class="mobile-nav">
    <button id="mobileNavToggle" class="mobile-nav-toggle">‚ò∞</button>
    <div id="mobileNavMenu" class="mobile-nav-menu">
      <a href="/index.html">Ana Sayfa</a>
      <a href="/products.html">√úr√ºnler</a>
      <a href="/orders.html">Sipari≈üler</a>
      </div>
  </div>
</header>

<main class="dashboard">
  <!-- ƒ∞statistikler -->
  <section class="stats-grid">
    <div class="stat-card">
      <h3>Toplam √úr√ºn</h3>
      <div class="stat-number" id="totalProducts">-</div>
      <div class="stat-label">Adet</div>
    </div>
    <div class="stat-card">
      <h3>Bekleyen Sipari≈üler</h3>
      <div class="stat-number" id="pendingOrders">-</div>
      <div class="stat-label">Sipari≈ü</div>
    </div>
    <div class="stat-card">
      <h3>Aktif Toplamalar</h3>
      <div class="stat-number" id="activePicks">-</div>
      <div class="stat-label">Pick</div>
    </div>
    <div class="stat-card">
      <h3>Sistem Durumu</h3>
      <div class="stat-number" id="systemStatus">-</div>
      <div class="stat-label">Status</div>
    </div>
  </section>

  <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
  <section class="card">
    <h2>Hƒ±zlƒ± ƒ∞≈ülemler</h2>
    <div class="quick-actions">
      <button class="action-btn" onclick="location.href='/products.html'">
        <span class="btn-icon">üì¶</span>
        <span class="btn-text">√úr√ºn Y√∂netimi</span>
      </button>
      <button class="action-btn" onclick="location.href='/orders.html'">
        <span class="btn-icon">üìã</span>
        <span class="btn-text">Sipari≈ü Y√∂netimi</span>
      </button>
      <button class="action-btn" id="syncAllBtn">
        <span class="btn-icon">üîÑ</span>
        <span class="btn-text">Wix Senkronizasyonu</span>
      </button>
    </div>
  </section>

  <!-- Son ƒ∞≈ülemler -->
  <section class="card">
    <h2>Son ƒ∞≈ülemler</h2>
    <div class="recent-activities">
      <div id="recentOrders" class="activity-section">
        <h3>Son Sipari≈üler</h3>
        <div class="activity-list" id="recentOrdersList">Y√ºkleniyor...</div>
      </div>
      <div id="recentPicks" class="activity-section">
        <h3>Son Toplamalar</h3>
        <div class="activity-list" id="recentPicksList">Y√ºkleniyor...</div>
      </div>
    </div>
  </section>

  <!-- Sistem Bilgileri -->
  <section class="card">
    <h2>Sistem Bilgileri</h2>
    <div class="system-info">
      <button id="checkHealth" class="info-btn">Sunucu Durumunu Kontrol Et</button>
      <pre id="healthOut" class="health-output"></pre>
      <div class="sync-status">
        <h4>Senkronizasyon Durumu</h4>
        <div id="syncStatus" class="sync-info">
          <div>Son √úr√ºn Sync: <span id="lastProductSync">-</span></div>
          <div>Son Sipari≈ü Sync: <span id="lastOrderSync">-</span></div>
        </div>
      </div>
    </div>
  </section>
</main>

<script type="module">
const API = {
  health: () => fetch('/api/health').then(r => r.json()),
  products: () => fetch('/api/products').then(r => r.json()),
  orders: () => fetch('/api/orders').then(r => r.json()),
  syncWixAll: () => fetch('/api/sync/wix/all', {method: 'POST'}).then(r => r.json()),
};

// Dashboard verilerini y√ºkle
async function loadDashboard() {
  try {
    // ƒ∞statistikleri y√ºkle
    const [health, products, orders] = await Promise.all([
      API.health(),
      API.products(),
      API.orders()
    ]);

    // Toplam √ºr√ºn sayƒ±sƒ±
    document.getElementById('totalProducts').textContent = products.length;

    // Bekleyen sipari≈üler (open, approved durumunda olanlar)
    const pendingCount = orders.filter(o => ['open', 'approved'].includes(o.status)).length;
    document.getElementById('pendingOrders').textContent = pendingCount;

    // Sistem durumu
    document.getElementById('systemStatus').textContent = health.status === 'ok' ? '‚úÖ' : '‚ùå';

    // Aktif toplamalar (≈üimdilik 0 - picks API'si yoksa)
    document.getElementById('activePicks').textContent = '0';

    // Son sipari≈üleri g√∂ster
    const recentOrdersHtml = orders.slice(0, 5).map(order => `
      <div class="activity-item">
        <div class="activity-text">
          <strong>${order.order_number}</strong> - ${order.customer_name || 'Anonim'}
        </div>
        <div class="activity-status status-${order.status}">${order.status}</div>
      </div>
    `).join('');
    document.getElementById('recentOrdersList').innerHTML = recentOrdersHtml;

    // Picks listesi (≈üimdilik bo≈ü)
    document.getElementById('recentPicksList').innerHTML = '<div class="activity-item">Hen√ºz toplama i≈ülemi yok</div>';

  } catch (error) {
    console.error('Dashboard y√ºkleme hatasƒ±:', error);
    document.getElementById('totalProducts').textContent = 'Hata';
    document.getElementById('pendingOrders').textContent = 'Hata';
    document.getElementById('systemStatus').textContent = '‚ùå';
  }
}

// Sunucu durumu kontrol√º
document.getElementById('checkHealth').addEventListener('click', async () => {
  try {
    const health = await API.health();
    document.getElementById('healthOut').textContent = JSON.stringify(health, null, 2);
    document.getElementById('systemStatus').textContent = health.status === 'ok' ? '‚úÖ' : '‚ùå';
  } catch (error) {
    document.getElementById('healthOut').textContent = 'Sunucu eri≈üilemez: ' + error.message;
    document.getElementById('systemStatus').textContent = '‚ùå';
  }
});

// Wix senkronizasyonu
document.getElementById('syncAllBtn').addEventListener('click', async () => {
  const btn = document.getElementById('syncAllBtn');
  const originalText = btn.innerHTML;
  
  btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Senkronize Ediliyor...</span>';
  btn.disabled = true;

  try {
    const result = await API.syncWixAll();
    console.log('Sync result:', result);
    
    // Ba≈üarƒ± mesajƒ±
    if (result.products?.ok && result.orders?.ok) {
      alert(`Senkronizasyon ba≈üarƒ±lƒ±!\n√úr√ºnler: +${result.products.imported}\nSipari≈üler: +${result.orders.importedOrders}`);
      
      // Sync zamanlarƒ±nƒ± g√ºncelle
      const now = new Date().toLocaleString('tr-TR');
      document.getElementById('lastProductSync').textContent = now;
      document.getElementById('lastOrderSync').textContent = now;
      
      // Dashboard'u yenile
      await loadDashboard();
    } else {
      alert('Senkronizasyonda sorun var. Detaylar i√ßin konsolu kontrol edin.');
    }
  } catch (error) {
    alert('Senkronizasyon hatasƒ±: ' + error.message);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});

// Mobile navigation toggle
document.getElementById('mobileNavToggle').addEventListener('click', () => {
  const menu = document.getElementById('mobileNavMenu');
  menu.classList.toggle('show');
});

// Close mobile menu when clicking outside
document.addEventListener('click', (e) => {
  const nav = document.getElementById('mobileNav');
  const menu = document.getElementById('mobileNavMenu');
  if (!nav.contains(e.target)) {
    menu.classList.remove('show');
  }
});

// Sayfa y√ºklendiƒüinde dashboard'u y√ºkle
document.addEventListener('DOMContentLoaded', loadDashboard);

// Her 30 saniyede bir otomatik yenile
setInterval(loadDashboard, 30000);
</script>
</body>
</html>
