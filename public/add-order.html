<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Manuel Sipari≈ü Ekleme</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth.js"></script>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS Y√∂netim Sistemi</h1>
    <span class="header-subtitle">Manuel Sipari≈ü Ekleme</span>
  </div>
  <div class="header-actions">
    <a href="/orders.html" class="action-btn">
      <span class="btn-icon">üìã</span>
      <span class="btn-text">Sipari≈ü Listesi</span>
    </a>
    <a href="/index.html" class="home-btn">
      <span class="home-icon">üè†</span>
      <span class="home-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="grid" style="max-width:900px;margin:auto;padding:16px">

  <!-- Sipari≈ü Bilgileri -->
  <section class="card">
    <h2>üìù Sipari≈ü Bilgileri</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sipari≈ü No * <small style="color: var(--muted);">(Otomatik olu≈üturulacak)</small></label>
        <input id="orderNumber" readonly style="width: 100%; background: var(--hover);" placeholder="Otomatik olu≈üturulacak..." />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sipari≈ü Tarihi</label>
        <input id="orderDate" type="date" style="width: 100%;" />
      </div>
      <div style="grid-column: 1 / -1;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">M√º≈üteri Adƒ± *</label>
        <input id="customerName" required style="width: 100%;" placeholder="M√º≈üteri adƒ±nƒ± girin" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">M√º≈üteri Telefon</label>
        <input id="customerPhone" type="tel" style="width: 100%;" placeholder="+90 555 123 4567" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">M√º≈üteri Email</label>
        <input id="customerEmail" type="email" style="width: 100%;" placeholder="musteri@example.com" />
      </div>
      <div style="grid-column: 1 / -1;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Teslimat Adresi</label>
        <textarea id="deliveryAddress" rows="2" style="width: 100%; resize: vertical;" placeholder="Teslimat adresi bilgileri..."></textarea>
      </div>
    </div>
  </section>

  <!-- √úr√ºn Ekleme -->
  <section class="card">
    <h2>üõçÔ∏è Sipari≈ü Kalemleri</h2>
    
    <div class="card" style="background: var(--hover); margin-bottom: 20px; padding: 15px;">
      <h3 style="margin: 0 0 15px 0;">√úr√ºn Ekle</h3>
      <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 100px; gap: 10px; align-items: end;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">√úr√ºn Se√ß *</label>
          <select id="productSelect" style="width: 100%;">
            <option value="">√úr√ºn se√ßin...</option>
          </select>
        </div>
        <div>
          <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Mevcut Stok</label>
          <input id="availableStock" readonly style="width: 100%; background: var(--muted); color: var(--fg);" placeholder="0" />
        </div>
        <div>
          <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Miktar *</label>
          <input id="orderQuantity" type="number" min="1" style="width: 100%;" placeholder="1" />
        </div>
        <div>
          <button id="addProductBtn" class="btn-primary" style="height: 40px;">
            ‚ûï Ekle
          </button>
        </div>
      </div>
      <div id="productWarning" style="display: none; color: var(--warning); margin-top: 10px; font-size: 0.9em;">
        ‚ö†Ô∏è Se√ßilen miktar mevcut stoktan fazla!
      </div>
    </div>

    <!-- Sipari≈ü Kalemleri Listesi -->
    <div class="table-container">
      <table id="orderItemsTable">
        <thead>
          <tr>
            <th>√úr√ºn</th>
            <th>SKU</th>
            <th>Birim Fiyat</th>
            <th>Miktar</th>
            <th>Toplam</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody id="orderItemsList">
          <tr id="emptyRow">
            <td colspan="6" style="text-align: center; padding: 30px; color: var(--muted);">
              <em>Hen√ºz √ºr√ºn eklenmedi. Yukarƒ±daki formdan √ºr√ºn ekleyin.</em>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Sipari≈ü √ñzeti -->
    <div class="card" style="background: var(--accent); color: white; margin-top: 20px; padding: 15px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
        <div>
          <div style="font-size: 1.2em; font-weight: bold;" id="totalItems">0</div>
          <div style="font-size: 0.9em; opacity: 0.8;">Toplam √úr√ºn</div>
        </div>
        <div>
          <div style="font-size: 1.2em; font-weight: bold;" id="totalQuantity">0</div>
          <div style="font-size: 0.9em; opacity: 0.8;">Toplam Adet</div>
        </div>
        <div>
          <div style="font-size: 1.5em; font-weight: bold;" id="totalPrice">‚Ç∫0.00</div>
          <div style="font-size: 0.9em; opacity: 0.8;">Toplam Tutar</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sipari≈ü Notlarƒ± -->
  <section class="card">
    <h2>üìã Sipari≈ü Notlarƒ±</h2>
    <textarea id="orderNotes" rows="3" style="width: 100%; resize: vertical;" placeholder="Sipari≈ü ile ilgili √∂zel notlar, talimatlar..."></textarea>
  </section>

  <!-- ƒ∞≈ülem Butonlarƒ± -->
  <section class="card">
    <div style="display: flex; gap: 15px; justify-content: flex-end;">
      <button onclick="clearForm()" style="background: var(--muted); color: var(--fg); padding: 12px 24px;">
        üóëÔ∏è Formu Temizle
      </button>
      <button onclick="saveDraft()" style="background: var(--warning); color: white; padding: 12px 24px;">
        üíæ Taslak Kaydet
      </button>
      <button id="createOrderBtn" onclick="createOrder()" class="btn-primary" style="padding: 12px 24px; font-size: 1.1em;">
        ‚úÖ Sipari≈üi Olu≈ütur
      </button>
    </div>
  </section>
</main>

<!-- Ba≈üarƒ± Modal -->
<div class="modal" id="successModal">
  <div class="panel" style="max-width: 500px;">
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 3em; margin-bottom: 15px;">üéâ</div>
      <h3 style="color: var(--success); margin-bottom: 15px;">Sipari≈ü Ba≈üarƒ±yla Olu≈üturuldu!</h3>
      <div style="background: var(--hover); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div><strong>Sipari≈ü No:</strong> <span id="createdOrderNumber"></span></div>
        <div><strong>M√º≈üteri:</strong> <span id="createdCustomerName"></span></div>
        <div><strong>Toplam Tutar:</strong> <span id="createdTotalPrice"></span></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="viewOrder()" class="btn-primary">üìã Sipari≈üi G√∂r√ºnt√ºle</button>
        <button onclick="createAnother()" style="background: var(--success); color: white;">‚ûï Yeni Sipari≈ü</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
const $ = (s) => document.querySelector(s);
const API = {
  async listProducts() { return fetch('/api/products').then(r => r.json()) },
  async createOrder(orderData) { 
    const response = await fetch('/api/orders', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(orderData)
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Sipari≈ü olu≈üturulurken hata olu≈ütu');
    return result;
  },
  async generateOrderNumber() {
    return fetch('/api/orders/generate-number').then(r => r.json());
  }
};

let products = [];
let orderItems = [];
let currentOrderNumber = '';

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  $('#orderDate').value = today;
  
  // Generate order number
  try {
    const orderNumberData = await API.generateOrderNumber();
    currentOrderNumber = orderNumberData.orderNumber;
    $('#orderNumber').value = currentOrderNumber;
  } catch (error) {
    // Fallback order number generation
    const timestamp = new Date().toISOString().replace(/[:.]/g, '').slice(0, 15);
    currentOrderNumber = `WMS-${timestamp}`;
    $('#orderNumber').value = currentOrderNumber;
  }
  
  // Load products
  await loadProducts();
  
  // Event listeners
  $('#productSelect').addEventListener('change', onProductSelect);
  $('#orderQuantity').addEventListener('input', validateQuantity);
  $('#addProductBtn').addEventListener('click', addProductToOrder);
});

async function loadProducts() {
  try {
    products = await API.listProducts();
    const select = $('#productSelect');
    select.innerHTML = '<option value="">√úr√ºn se√ßin...</option>';
    
    products.forEach(product => {
      const option = document.createElement('option');
      option.value = product.id;
      option.textContent = `${product.name} (${product.sku}) - ‚Ç∫${(product.price || 0).toFixed(2)}`;
      option.dataset.product = JSON.stringify(product);
      select.appendChild(option);
    });
    
    console.log(`‚úÖ ${products.length} √ºr√ºn y√ºklendi`);
  } catch (error) {
    console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
    alert('√úr√ºnler y√ºklenirken hata olu≈ütu: ' + error.message);
  }
}

function onProductSelect() {
  const select = $('#productSelect');
  const selectedOption = select.selectedOptions[0];
  
  if (!selectedOption || !selectedOption.value) {
    $('#availableStock').value = '';
    $('#orderQuantity').value = '';
    return;
  }
  
  const product = JSON.parse(selectedOption.dataset.product);
  $('#availableStock').value = product.inventory_quantity || 0;
  $('#orderQuantity').value = 1;
  $('#orderQuantity').focus();
  
  validateQuantity();
}

function validateQuantity() {
  const select = $('#productSelect');
  const selectedOption = select.selectedOptions[0];
  
  if (!selectedOption || !selectedOption.value) return;
  
  const product = JSON.parse(selectedOption.dataset.product);
  const requestedQty = parseInt($('#orderQuantity').value) || 0;
  const availableStock = product.inventory_quantity || 0;
  
  const warning = $('#productWarning');
  const addBtn = $('#addProductBtn');
  
  if (requestedQty > availableStock) {
    warning.style.display = 'block';
    warning.innerHTML = `‚ö†Ô∏è ƒ∞stenen miktar (${requestedQty}) mevcut stoktan (${availableStock}) fazla!`;
    addBtn.style.background = 'var(--warning)';
    addBtn.innerHTML = '‚ö†Ô∏è Yine de Ekle';
  } else {
    warning.style.display = 'none';
    addBtn.style.background = '';
    addBtn.innerHTML = '‚ûï Ekle';
  }
}

function addProductToOrder() {
  const select = $('#productSelect');
  const selectedOption = select.selectedOptions[0];
  
  if (!selectedOption || !selectedOption.value) {
    alert('L√ºtfen bir √ºr√ºn se√ßin!');
    return;
  }
  
  const quantity = parseInt($('#orderQuantity').value);
  if (!quantity || quantity < 1) {
    alert('L√ºtfen ge√ßerli bir miktar girin!');
    return;
  }
  
  const product = JSON.parse(selectedOption.dataset.product);
  
  // Check if product already in order
  const existingItem = orderItems.find(item => item.productId === product.id);
  if (existingItem) {
    alert('Bu √ºr√ºn zaten sipari≈üte var! Miktarƒ±nƒ± deƒüi≈ütirmek i√ßin tablodan d√ºzenleyin.');
    return;
  }
  
  // Add to order items
  const orderItem = {
    productId: product.id,
    sku: product.sku,
    name: product.name,
    price: product.price || 0,
    quantity: quantity,
    total: (product.price || 0) * quantity
  };
  
  orderItems.push(orderItem);
  updateOrderItemsTable();
  updateOrderSummary();
  
  // Clear form
  $('#productSelect').value = '';
  $('#availableStock').value = '';
  $('#orderQuantity').value = '';
  $('#productWarning').style.display = 'none';
  
  console.log('‚úÖ √úr√ºn sipari≈üe eklendi:', orderItem);
}

function updateOrderItemsTable() {
  const tbody = $('#orderItemsList');
  
  if (orderItems.length === 0) {
    tbody.innerHTML = `
      <tr id="emptyRow">
        <td colspan="6" style="text-align: center; padding: 30px; color: var(--muted);">
          <em>Hen√ºz √ºr√ºn eklenmedi. Yukarƒ±daki formdan √ºr√ºn ekleyin.</em>
        </td>
      </tr>`;
    return;
  }
  
  tbody.innerHTML = orderItems.map((item, index) => `
    <tr>
      <td><strong>${item.name}</strong></td>
      <td><code style="background: var(--hover); padding: 2px 6px; border-radius: 4px;">${item.sku}</code></td>
      <td>‚Ç∫${item.price.toFixed(2)}</td>
      <td>
        <input type="number" min="1" value="${item.quantity}" 
               onchange="updateItemQuantity(${index}, this.value)"
               style="width: 80px; text-align: center;" />
      </td>
      <td><strong>‚Ç∫${item.total.toFixed(2)}</strong></td>
      <td>
        <button onclick="removeOrderItem(${index})" 
                style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px;">
          üóëÔ∏è Sil
        </button>
      </td>
    </tr>
  `).join('');
}

function updateItemQuantity(index, newQuantity) {
  const quantity = parseInt(newQuantity) || 1;
  orderItems[index].quantity = quantity;
  orderItems[index].total = orderItems[index].price * quantity;
  updateOrderItemsTable();
  updateOrderSummary();
}

function removeOrderItem(index) {
  const item = orderItems[index];
  if (confirm(`"${item.name}" √ºr√ºn√ºn√º sipari≈üten √ßƒ±karmak istediƒüinizden emin misiniz?`)) {
    orderItems.splice(index, 1);
    updateOrderItemsTable();
    updateOrderSummary();
  }
}

function updateOrderSummary() {
  const totalItems = orderItems.length;
  const totalQuantity = orderItems.reduce((sum, item) => sum + item.quantity, 0);
  const totalPrice = orderItems.reduce((sum, item) => sum + item.total, 0);
  
  $('#totalItems').textContent = totalItems;
  $('#totalQuantity').textContent = totalQuantity;
  $('#totalPrice').textContent = `‚Ç∫${totalPrice.toFixed(2)}`;
}

function clearForm() {
  if (orderItems.length > 0) {
    if (!confirm('Formu temizlemek istediƒüinizden emin misiniz? T√ºm girilen bilgiler silinecek.')) {
      return;
    }
  }
  
  // Clear customer info
  $('#customerName').value = '';
  $('#customerPhone').value = '';
  $('#customerEmail').value = '';
  $('#deliveryAddress').value = '';
  $('#orderNotes').value = '';
  
  // Clear order items
  orderItems = [];
  updateOrderItemsTable();
  updateOrderSummary();
  
  // Clear product selection
  $('#productSelect').value = '';
  $('#availableStock').value = '';
  $('#orderQuantity').value = '';
  $('#productWarning').style.display = 'none';
  
  console.log('üóëÔ∏è Form temizlendi');
}

function saveDraft() {
  // TODO: Implement draft saving functionality
  alert('üíæ Taslak kaydetme √∂zelliƒüi gelecek versiyonlarda eklenecek!');
}

async function createOrder() {
  // Validation
  const customerName = $('#customerName').value.trim();
  if (!customerName) {
    alert('‚ùå M√º≈üteri adƒ± zorunludur!');
    $('#customerName').focus();
    return;
  }
  
  if (orderItems.length === 0) {
    alert('‚ùå Sipari≈ü i√ßin en az bir √ºr√ºn eklemelisiniz!');
    return;
  }
  
  const createBtn = $('#createOrderBtn');
  const originalText = createBtn.innerHTML;
  createBtn.innerHTML = '‚è≥ Sipari≈ü Olu≈üturuluyor...';
  createBtn.disabled = true;
  
  try {
    const orderData = {
      order_number: currentOrderNumber,
      customer_name: customerName,
      customer_phone: $('#customerPhone').value.trim() || null,
      customer_email: $('#customerEmail').value.trim() || null,
      delivery_address: $('#deliveryAddress').value.trim() || null,
      order_date: $('#orderDate').value,
      notes: $('#orderNotes').value.trim() || null,
      items: orderItems.map(item => ({
        product_id: item.productId,
        sku: item.sku,
        product_name: item.name,
        quantity: item.quantity,
        unit_price: item.price
      }))
    };
    
    console.log('üì§ Sipari≈ü g√∂nderiliyor:', orderData);
    
    const result = await API.createOrder(orderData);
    
    console.log('‚úÖ Sipari≈ü olu≈üturuldu:', result);
    
    // Show success modal
    $('#createdOrderNumber').textContent = result.order_number;
    $('#createdCustomerName').textContent = customerName;
    $('#createdTotalPrice').textContent = $('#totalPrice').textContent;
    document.getElementById('successModal').classList.add('show');
    
  } catch (error) {
    console.error('‚ùå Sipari≈ü olu≈üturma hatasƒ±:', error);
    alert('‚ùå Sipari≈ü olu≈üturulurken hata olu≈ütu:\n' + error.message);
  } finally {
    createBtn.innerHTML = originalText;
    createBtn.disabled = false;
  }
}

function viewOrder() {
  document.getElementById('successModal').classList.remove('show');
  window.location.href = '/orders.html';
}

function createAnother() {
  document.getElementById('successModal').classList.remove('show');
  clearForm();
  
  // Generate new order number
  const timestamp = new Date().toISOString().replace(/[:.]/g, '').slice(0, 15);
  currentOrderNumber = `WMS-${timestamp}`;
  $('#orderNumber').value = currentOrderNumber;
}

// Global functions
window.updateItemQuantity = updateItemQuantity;
window.removeOrderItem = removeOrderItem;
window.clearForm = clearForm;
window.saveDraft = saveDraft;
window.createOrder = createOrder;
window.viewOrder = viewOrder;
window.createAnother = createAnother;

</script>
</body>
</html>